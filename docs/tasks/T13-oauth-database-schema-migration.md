# Task T13: OAuth Database Schema and Migration

**Story Reference:** US4-oauth-provider-configuration.md
**Type:** Database
**Priority:** High
**Estimated Effort:** 2-3 hours
**Prerequisites:** None

## Objective

Create database migration for the `altalune_oauth_providers` table (global, non-partitioned) with proper constraints to support OAuth provider configuration storage with encrypted client secrets.

## Acceptance Criteria

- [ ] Migration file created with proper up/down migrations
- [ ] `altalune_oauth_providers` table created with all required columns
- [ ] UNIQUE constraint on `provider_type` enforced (one Google, one Github, etc.)
- [ ] Check constraint on `provider_type` enum values
- [ ] Migration runs successfully without errors
- [ ] Table structure documented in migration comments
- [ ] user_identities table reference documented (already exists from US3)

## Technical Requirements

### Table: altalune_oauth_providers

**Architecture Decision:** This is a **GLOBAL table** (not partitioned by project_id) because OAuth providers are system-wide configuration, not per-project.

**Schema:**
```sql
CREATE TABLE IF NOT EXISTS altalune_oauth_providers (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  public_id VARCHAR(20) NOT NULL UNIQUE,
  provider_type VARCHAR(20) NOT NULL UNIQUE,  -- 'google', 'github', 'microsoft', 'apple'
  client_id VARCHAR(500) NOT NULL,
  client_secret TEXT NOT NULL,                -- Encrypted with AES-256-GCM, stored as base64
  redirect_url VARCHAR(500) NOT NULL,
  scopes VARCHAR(1000),                       -- Comma-separated scopes
  enabled BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT chk_oauth_providers_type CHECK (
    provider_type IN ('google', 'github', 'microsoft', 'apple')
  )
);
```

**Indexes:**
- UNIQUE: `public_id` (for API lookups)
- UNIQUE: `provider_type` (enforce one provider per type)
- INDEX: `enabled` (for filtering)

**Key Constraints:**
1. **provider_type UNIQUE** - Critical: Only one provider configuration per type
2. **Check constraint** - Validates provider_type is one of: google, github, microsoft, apple
3. **client_secret TEXT** - Must be TEXT (not VARCHAR) because encrypted ciphertext can exceed VARCHAR(500)
4. **enabled boolean** - For soft enable/disable without deletion

## Implementation Details

### Migration File Structure

**File:** `database/migrations/20260107000000_create_oauth_tables.sql`

**Goose Format:**
```sql
-- +goose Up
-- +goose StatementBegin

-- =============================================================================
-- OAUTH PROVIDER TABLES (GLOBAL - NON-PARTITIONED)
-- =============================================================================
-- CRITICAL: These tables are GLOBAL and do NOT include project_id columns.
-- OAuth providers are system-wide, not per-project.
-- =============================================================================

-- [Table creation SQL here]

-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin

DROP TABLE IF EXISTS altalune_oauth_providers;

-- +goose StatementEnd
```

### Column Specifications

| Column | Type | Constraints | Purpose |
|--------|------|-------------|---------|
| `id` | BIGINT | PRIMARY KEY, IDENTITY | Internal ID |
| `public_id` | VARCHAR(20) | NOT NULL, UNIQUE | Nanoid for API (14 chars) |
| `provider_type` | VARCHAR(20) | NOT NULL, UNIQUE, CHECK | google/github/microsoft/apple |
| `client_id` | VARCHAR(500) | NOT NULL | OAuth client ID from provider |
| `client_secret` | TEXT | NOT NULL | AES-256-GCM encrypted secret |
| `redirect_url` | VARCHAR(500) | NOT NULL | OAuth callback URL |
| `scopes` | VARCHAR(1000) | NULL | Comma-separated scopes |
| `enabled` | BOOLEAN | NOT NULL, DEFAULT true | Provider enabled status |
| `created_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW | Creation timestamp |
| `updated_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW | Update timestamp |

### Why NOT Partitioned?

Unlike `altalune_project_api_keys` which is partitioned by `project_id`, OAuth providers are:
- **System-wide configuration** - Not owned by specific projects
- **Singleton per type** - Only one Google provider for entire system
- **Globally accessible** - All projects use the same OAuth providers

## Files to Create

- `database/migrations/20260107000000_create_oauth_tables.sql` - Complete migration file

## Files to Modify

- None (new migration file only)

## Testing Requirements

### Migration Testing

**Run migration up:**
```bash
./bin/app migrate -c config.yaml
```

**Verify table creation:**
```sql
\d altalune_oauth_providers
```

**Expected output:**
- Table structure matches schema
- Constraints are created (PK, UNIQUE, CHECK)
- Indexes are created
- Defaults are set correctly

**Test constraint enforcement:**
```sql
-- Test UNIQUE constraint on provider_type
INSERT INTO altalune_oauth_providers (public_id, provider_type, client_id, client_secret, redirect_url)
VALUES ('test123', 'google', 'client1', 'secret1', 'http://localhost');

-- This should FAIL (duplicate provider_type)
INSERT INTO altalune_oauth_providers (public_id, provider_type, client_id, client_secret, redirect_url)
VALUES ('test456', 'google', 'client2', 'secret2', 'http://localhost');

-- Test CHECK constraint
-- This should FAIL (invalid provider_type)
INSERT INTO altalune_oauth_providers (public_id, provider_type, client_id, client_secret, redirect_url)
VALUES ('test789', 'invalid', 'client3', 'secret3', 'http://localhost');
```

**Test rollback:**
```bash
# Rollback migration
./bin/app migrate down -c config.yaml

# Verify table dropped
\dt altalune_oauth_providers  # Should not exist
```

## Commands to Run

```bash
# 1. Create migration file
touch database/migrations/20260107000000_create_oauth_tables.sql

# 2. Edit migration file (add SQL)

# 3. Run migration
./bin/app migrate -c config.yaml

# 4. Verify in PostgreSQL
psql -d altalune_db -c "\d altalune_oauth_providers"

# 5. Test constraints (optional)
psql -d altalune_db -f database/test_oauth_constraints.sql
```

## Validation Checklist

- [ ] Migration file follows Goose format (-- +goose Up/Down)
- [ ] Table name is `altalune_oauth_providers` (plural)
- [ ] All columns defined with correct types
- [ ] PRIMARY KEY on `id`
- [ ] UNIQUE constraint on `public_id`
- [ ] UNIQUE constraint on `provider_type` (critical!)
- [ ] CHECK constraint on `provider_type` enum
- [ ] INDEX on `enabled` column
- [ ] `client_secret` is TEXT (not VARCHAR)
- [ ] Timestamps have DEFAULT CURRENT_TIMESTAMP
- [ ] Comments document why table is global (not partitioned)
- [ ] Migration down drops table correctly

## Definition of Done

- [ ] Migration file created and committed
- [ ] Migration runs successfully (up)
- [ ] Migration rollback works (down)
- [ ] Table structure verified in database
- [ ] UNIQUE constraint on provider_type tested and working
- [ ] CHECK constraint on provider_type tested and working
- [ ] All indexes created
- [ ] Comments explain global table design decision
- [ ] No errors in migration output

## Dependencies

**None** - This is the first task and has no dependencies.

**Enables:**
- T14 (Crypto) can run in parallel
- T15 (Backend) requires this migration to exist for testing

## Risk Factors

- **Low Risk**: Straightforward table creation
- **Low Risk**: No data migration needed (new table)
- **Medium Risk**: UNIQUE constraint on provider_type must be correct (verify carefully)

**Mitigation:**
- Test constraints thoroughly before moving to backend implementation
- Document why only one provider per type is allowed

## Notes

### user_identities Table Reference

The `altalune_user_identities` table was already created in migration `20260105000000_create_iam_tables.sql` (US3). This table links users to OAuth identities but is NOT managed in US4.

**Schema (for reference):**
```sql
-- Already exists from US3
CREATE TABLE IF NOT EXISTS altalune_user_identities (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  public_id VARCHAR(20) NOT NULL UNIQUE,
  user_id BIGINT NOT NULL,
  provider VARCHAR(20) NOT NULL,        -- 'google', 'github', etc.
  provider_user_id VARCHAR(255) NOT NULL,
  email VARCHAR(255),
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_user_identities_user_id
    FOREIGN KEY (user_id) REFERENCES altalune_users (id)
    ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT uq_user_identities_provider_user UNIQUE (provider, provider_user_id)
);
```

### Why client_secret is TEXT

Encrypted data (AES-256-GCM output) is base64-encoded and can exceed VARCHAR(500):
- Original secret: up to 500 chars
- AES-GCM adds nonce (12 bytes) + authentication tag (16 bytes)
- Base64 encoding increases size by ~33%
- Result: Can exceed VARCHAR(500), use TEXT

### Migration Naming Convention

Format: `YYYYMMDDHHMMSS_description.sql`
- `20260107000000` - January 7, 2026, 00:00:00
- Use actual date when creating migration

### Testing Tip

Create a separate test SQL file for constraint testing:
```sql
-- database/test_oauth_constraints.sql
BEGIN;
-- Test queries here
ROLLBACK;  -- Don't commit test data
```
