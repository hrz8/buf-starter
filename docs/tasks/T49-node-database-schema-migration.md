# Task T49: Node Database Schema & Migration

**Story Reference:** US12-node-editor.md
**Type:** Database
**Priority:** High
**Estimated Effort:** 1-2 hours
**Prerequisites:** T43 (chatbot database schema exists)

## Objective

Create database migration for `altalune_chatbot_nodes` table with partition support and auto-creation of default `start_conversation_en` node on project creation.

## Acceptance Criteria

- [ ] Migration creates partitioned `altalune_chatbot_nodes` table
- [ ] Table added to `partitionedTables` in project repo
- [ ] Indexes created for: public_id, name+lang (unique), enabled, tags (GIN)
- [ ] Default `start_conversation_en` node auto-created on new project creation
- [ ] Migration includes down migration for rollback

## Technical Requirements

### Database Schema

```sql
CREATE TABLE altalune_chatbot_nodes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  public_id VARCHAR(20) NOT NULL,
  project_id BIGINT NOT NULL,
  name VARCHAR(100) NOT NULL,
  lang VARCHAR(10) NOT NULL DEFAULT 'en',
  tags TEXT[] NOT NULL DEFAULT '{}',
  enabled BOOLEAN NOT NULL DEFAULT true,
  triggers JSONB NOT NULL DEFAULT '[]',
  messages JSONB NOT NULL DEFAULT '[]',
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (project_id, id),
  CONSTRAINT fk_altalune_chatbot_nodes_project_id
    FOREIGN KEY (project_id) REFERENCES altalune_projects (id)
    ON DELETE CASCADE ON UPDATE CASCADE
) PARTITION BY LIST (project_id);

CREATE UNIQUE INDEX IF NOT EXISTS ux_altalune_chatbot_nodes_public_id
  ON altalune_chatbot_nodes (project_id, public_id);
CREATE UNIQUE INDEX IF NOT EXISTS ux_altalune_chatbot_nodes_name_lang
  ON altalune_chatbot_nodes (project_id, name, lang);
CREATE INDEX IF NOT EXISTS ix_altalune_chatbot_nodes_enabled
  ON altalune_chatbot_nodes (project_id, enabled);
CREATE INDEX IF NOT EXISTS ix_altalune_chatbot_nodes_tags
  ON altalune_chatbot_nodes USING GIN (tags);
```

### Default Node (start_conversation_en-US)

```json
{
  "name": "start_conversation",
  "lang": "en-US",
  "tags": [],
  "enabled": true,
  "triggers": [{ "type": "equals", "value": "start" }],
  "messages": [{ "role": "assistant", "content": "Hello! How can I help you today?" }]
}
```

## Files to Create

- `database/migrations/20260120000000_create_chatbot_nodes_table.sql` - Main table creation
- `database/migrations/20260120010000_fix_chatbot_nodes_lang_default.sql` - Fix lang default to `en-US`

## Files to Modify

- `internal/domain/project/repo.go`
  - Add `"altalune_chatbot_nodes"` to `partitionedTables` slice
  - Add `createDefaultChatbotNode()` method
  - Call `createDefaultChatbotNode()` in `Create()` method after partition creation

## Commands to Run

```bash
# Build to verify compilation
make build

# Run migrations (after building)
./bin/app migrate up -c config.yaml
```

## Validation Checklist

- [ ] Migration applies successfully: `./bin/app migrate up`
- [ ] New project creates partition + default node
- [ ] Default node has correct trigger and message structure
- [ ] Unique constraint prevents duplicate name+lang per project
- [ ] Down migration works: drops table cascade

## Definition of Done

- [ ] Migration file created with correct Goose annotations
- [ ] Table uses partitioning by project_id
- [ ] Table added to `partitionedTables` slice
- [ ] Default node creation method implemented
- [ ] Default node called during project creation
- [ ] Build succeeds without errors
- [ ] Migration applies cleanly

## Risk Factors

- **Low Risk**: Standard migration pattern following T43 example

## Notes

- Table has unique constraint on `(project_id, name, lang)` allowing same name in different languages
- The `triggers` JSONB column stores array of trigger objects
- The `messages` JSONB column stores array of message objects (OpenAI format)
- GIN index on tags enables efficient array containment queries
