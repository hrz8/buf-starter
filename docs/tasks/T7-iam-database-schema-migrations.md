# Task T7: IAM Database Schema and Migrations

**Story Reference:** US3-iam-core-entities-and-mappings.md
**Type:** Database Foundation
**Priority:** High
**Estimated Effort:** 6-8 hours

## Objective

Create the database schema for the Identity & Access Management (IAM) system with global (non-partitioned) tables for users, roles, permissions, mappings, and OAuth user identities.

## Acceptance Criteria

- [ ] Create migration for 8 IAM tables (users, roles, permissions, 4 junction tables, user_identities)
- [ ] All tables use GLOBAL (non-partitioned) pattern - NO project_id columns
- [ ] Permissions table with name (machine-readable, NOT NULL) and description (human-readable, NULLABLE)
- [ ] Cascade delete configuration for all foreign key relationships
- [ ] Seed data migration with super_admin role, root permission, and mock user
- [ ] Permission name validation supports colons (^[a-zA-Z0-9_:]+$)
- [ ] All migrations run successfully with `./bin/app migrate`
- [ ] Database schema matches IAM requirements exactly

## Technical Requirements

### Tables to Create

#### 1. altalune_users
```sql
CREATE TABLE altalune_users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  public_id VARCHAR(20) NOT NULL UNIQUE,
  email VARCHAR(255) NOT NULL UNIQUE,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT chk_users_email_lowercase CHECK (email = LOWER(email))
);
```

#### 2. altalune_roles
```sql
CREATE TABLE altalune_roles (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  public_id VARCHAR(20) NOT NULL UNIQUE,
  name VARCHAR(100) NOT NULL UNIQUE,
  description TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

#### 3. altalune_permissions
```sql
CREATE TABLE altalune_permissions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  public_id VARCHAR(20) NOT NULL UNIQUE,
  name VARCHAR(100) NOT NULL UNIQUE,  -- Machine-readable: "project:read"
  effect VARCHAR(10) NOT NULL DEFAULT 'allow',
  description TEXT,  -- Human-readable: "Access read project"
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT chk_permissions_name CHECK (name ~ '^[a-zA-Z0-9_:]+$'),
  CONSTRAINT chk_permissions_effect CHECK (effect IN ('allow', 'deny'))
);
```

#### 4. altalune_users_roles (Junction Table)
```sql
CREATE TABLE altalune_users_roles (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id BIGINT NOT NULL,
  role_id BIGINT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES altalune_users (id) ON DELETE CASCADE,
  FOREIGN KEY (role_id) REFERENCES altalune_roles (id) ON DELETE CASCADE,
  UNIQUE (user_id, role_id)
);
```

#### 5. altalune_roles_permissions (Junction Table)
```sql
CREATE TABLE altalune_roles_permissions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  role_id BIGINT NOT NULL,
  permission_id BIGINT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (role_id) REFERENCES altalune_roles (id) ON DELETE CASCADE,
  FOREIGN KEY (permission_id) REFERENCES altalune_permissions (id) ON DELETE CASCADE,
  UNIQUE (role_id, permission_id)
);
```

#### 6. altalune_users_permissions (Junction Table)
```sql
CREATE TABLE altalune_users_permissions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id BIGINT NOT NULL,
  permission_id BIGINT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES altalune_users (id) ON DELETE CASCADE,
  FOREIGN KEY (permission_id) REFERENCES altalune_permissions (id) ON DELETE CASCADE,
  UNIQUE (user_id, permission_id)
);
```

#### 7. altalune_project_members (Project Access)
```sql
CREATE TABLE altalune_project_members (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  project_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  role VARCHAR(20) NOT NULL,  -- owner, admin, member, viewer
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES altalune_projects (id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES altalune_users (id) ON DELETE CASCADE,
  UNIQUE (project_id, user_id),
  CONSTRAINT chk_project_members_role CHECK (role IN ('owner', 'admin', 'member', 'viewer'))
);
```

#### 8. altalune_user_identities (OAuth Identities)
```sql
CREATE TABLE altalune_user_identities (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  public_id VARCHAR(20) NOT NULL UNIQUE,
  user_id BIGINT NOT NULL,
  provider VARCHAR(50) NOT NULL,  -- google, github, etc.
  provider_user_id VARCHAR(255) NOT NULL,  -- External provider's user ID
  email VARCHAR(255),
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES altalune_users (id) ON DELETE CASCADE,
  UNIQUE (provider, provider_user_id)
);
```

### Seed Data Requirements

Create seed migration with:
1. **super_admin role** with description "System super administrator"
2. **root permission** with:
   - name: "root" (wildcard permission)
   - effect: "allow"
   - description: "Full system access - wildcard permission"
3. **Mock super admin user**:
   - email: "admin@altalune.local"
   - first_name: "Super"
   - last_name: "Admin"
   - is_active: true
   - OAuth identity with mock Google provider data
   - Assigned super_admin role
   - Assigned root permission

### Indexes Required

```sql
-- Users
CREATE INDEX idx_users_email ON altalune_users (email);
CREATE INDEX idx_users_is_active ON altalune_users (is_active);

-- Roles
CREATE INDEX idx_roles_name ON altalune_roles (name);

-- Permissions
CREATE INDEX idx_permissions_name ON altalune_permissions (name);
CREATE INDEX idx_permissions_effect ON altalune_permissions (effect);

-- User Roles
CREATE INDEX idx_users_roles_user_id ON altalune_users_roles (user_id);
CREATE INDEX idx_users_roles_role_id ON altalune_users_roles (role_id);

-- Roles Permissions
CREATE INDEX idx_roles_permissions_role_id ON altalune_roles_permissions (role_id);
CREATE INDEX idx_roles_permissions_permission_id ON altalune_roles_permissions (permission_id);

-- Users Permissions
CREATE INDEX idx_users_permissions_user_id ON altalune_users_permissions (user_id);
CREATE INDEX idx_users_permissions_permission_id ON altalune_users_permissions (permission_id);

-- Project Members
CREATE INDEX idx_project_members_project_id ON altalune_project_members (project_id);
CREATE INDEX idx_project_members_user_id ON altalune_project_members (user_id);
CREATE INDEX idx_project_members_role ON altalune_project_members (role);

-- User Identities
CREATE INDEX idx_user_identities_user_id ON altalune_user_identities (user_id);
CREATE INDEX idx_user_identities_provider ON altalune_user_identities (provider);
```

## Implementation Notes

### Key Differences from Existing Partitioned Tables

**CRITICAL**: These IAM tables are GLOBAL (non-partitioned), which differs from existing patterns:

1. **NO project_id column** in users, roles, permissions tables
2. **Simple primary keys**: Just `id` (not composite with project_id)
3. **Unique indexes**: Don't need partition key
4. **Foreign keys**: Direct references without project_id constraints
5. **Query patterns**: NO project_id filtering in WHERE clauses

### Permission Table Design

- **name**: Machine-readable format supporting colons (e.g., "project:read", "user:manage:delete")
- **description**: Human-readable explanation shown in UI tooltips/hover states
- **effect**: "allow" or "deny" (evaluation logic deferred to middleware)

### Cascade Delete Strategy

All junction tables use `ON DELETE CASCADE` to automatically:
- Remove user-role assignments when user or role is deleted
- Remove role-permission assignments when role or permission is deleted
- Remove user-permission assignments when user or permission is deleted
- Remove project member assignments when project or user is deleted

### Migration File Naming

Follow Goose naming convention:
- `YYYYMMDDHHMMSS_create_iam_tables.sql`
- `YYYYMMDDHHMMSS_seed_iam_data.sql`

Use sequential timestamps to ensure proper ordering.

## Files to Create

- `database/migrations/[timestamp]_create_iam_tables.sql`
- `database/migrations/[timestamp]_seed_iam_data.sql`

## Commands to Run

```bash
# Run migrations
./bin/app migrate -c config.yaml

# Verify migrations
psql -h localhost -U youruser -d yourdb -c "\dt altalune_*"
psql -h localhost -U youruser -d yourdb -c "SELECT * FROM altalune_roles;"
psql -h localhost -U youruser -d yourdb -c "SELECT * FROM altalune_permissions;"
psql -h localhost -U youruser -d yourdb -c "SELECT * FROM altalune_users;"
```

## Definition of Done

- [ ] All 8 tables created successfully
- [ ] All indexes created successfully
- [ ] Seed data inserted (super_admin role, root permission, mock user)
- [ ] Migrations are idempotent (can run multiple times safely)
- [ ] Foreign key constraints working correctly
- [ ] Cascade deletes verified (delete a user removes all their mappings)
- [ ] CHECK constraints validated (permission name regex, effect enum, project role enum)
- [ ] Email lowercase constraint working
- [ ] Unique constraints preventing duplicates (email, permission name, role name)

## Dependencies

- Existing database and migration infrastructure
- Goose migration tool
- altalune_projects table (for project_members foreign key)

## Risk Factors

- **Medium risk**: First non-partitioned tables in the system - different pattern
- **Watch out for**: Accidentally adding project_id columns (don't!)
- **Test carefully**: Cascade deletes to ensure proper cleanup
- **Verify**: Permission name regex allows colons but prevents invalid characters
