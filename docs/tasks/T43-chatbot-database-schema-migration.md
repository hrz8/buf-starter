# Task T43: Chatbot Database Schema & Migration

**Story Reference:** US11-chatbot-configuration-foundation.md
**Type:** Database
**Priority:** High
**Estimated Effort:** 1-2 hours
**Prerequisites:** None

## Objective

Create database migration for `altalune_chatbot_configs` table and integrate with project partition system. This establishes the foundational database schema for chatbot configuration storage.

## Acceptance Criteria

- [x] Migration creates partitioned `altalune_chatbot_configs` table
- [x] Table added to `partitionedTables` in project repo
- [x] Default chatbot config auto-created on new project creation
- [x] Migration is idempotent and includes down migration

## Technical Requirements

### Database Schema

```sql
CREATE TABLE IF NOT EXISTS altalune_chatbot_configs (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  public_id VARCHAR(20) NOT NULL,
  project_id BIGINT NOT NULL,
  modules_config JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (project_id, id),
  CONSTRAINT fk_altalune_chatbot_configs_project_id
    FOREIGN KEY (project_id) REFERENCES altalune_projects (id)
    ON DELETE CASCADE ON UPDATE CASCADE
) PARTITION BY LIST (project_id);

CREATE UNIQUE INDEX IF NOT EXISTS ux_altalune_chatbot_configs_public_id
  ON altalune_chatbot_configs (project_id, public_id);

-- Only one config per project
CREATE UNIQUE INDEX IF NOT EXISTS ux_altalune_chatbot_configs_project_id
  ON altalune_chatbot_configs (project_id);
```

### Default JSONB Structure (modules_config)

```json
{
  "llm": {
    "enabled": false,
    "model": "",
    "temperature": 0.7,
    "maxToolCalls": 5
  },
  "mcpServer": {
    "enabled": false,
    "urls": [],
    "structuredOutputs": []
  },
  "widget": {
    "enabled": false,
    "cors": {
      "allowedOrigins": [],
      "allowedHeaders": ["Content-Type"],
      "credentials": false
    }
  },
  "prompt": {
    "enabled": true,
    "systemPrompt": "You are a helpful assistant."
  }
}
```

### Auto-Creation on Project Creation

Add method `createDefaultChatbotConfig()` to project repo that:
1. Checks if config already exists (idempotent)
2. Generates public_id using nanoid
3. Inserts default config with the JSONB structure above
4. Called after `createPartitionsForProject()` in `Create()` method

## Files to Create

- `database/migrations/YYYYMMDDHHMMSS_create_chatbot_configs_table.sql`

## Files to Modify

- `internal/domain/project/repo.go`
  - Add `"altalune_chatbot_configs"` to `partitionedTables` slice
  - Add `createDefaultChatbotConfig()` method
  - Call `createDefaultChatbotConfig()` in `Create()` method after partition creation

## Commands to Run

```bash
# Build to verify compilation
make build

# Run migrations (after building)
./bin/app migrate -c config.yaml
```

## Validation Checklist

- [ ] Migration applies successfully: `./bin/app migrate`
- [ ] New project creates partition for chatbot_configs table
- [ ] New project auto-creates default chatbot config record
- [ ] Config retrieved correctly with JSONB data structure
- [ ] Down migration works: drops table cascade

## Definition of Done

- [x] Migration file created with correct Goose annotations
- [x] Table uses partitioning by project_id
- [x] Table added to partitionedTables slice
- [x] Default config creation method implemented
- [x] Default config called during project creation
- [x] Build succeeds without errors
- [ ] Migration applies cleanly (requires running ./bin/app migrate)

## Risk Factors

- **Low Risk**: Standard migration pattern following existing examples

## Notes

- Table has unique constraint on `project_id` ensuring only one config per project
- The `modules_config` JSONB column stores all module configurations in one field
- Each module has an `enabled` boolean flag for toggling
- Default config has `prompt` enabled by default with basic system prompt
