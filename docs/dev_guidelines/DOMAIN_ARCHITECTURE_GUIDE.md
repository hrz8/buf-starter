## Domain Architecture Patterns

### Domain Structure

Each domain follows a consistent 7-file pattern in `internal/domain/{domain_name}/`:

1. **model.go** - Domain models, enums, input/result structs, proto conversion
2. **interface.go** - Repository interface definitions
3. **repo.go** - Database repository implementation with pgx
4. **service.go** - Business logic service implementing gRPC server interface
5. **handler.go** - Connect-RPC HTTP handlers (thin wrappers around service)
6. **mapper.go** - Helper functions for proto ↔ domain conversions
7. **errors.go** - Domain-specific error definitions

### Dual ID System

- **Public ID**: 14-character nanoid strings for external APIs (generated by `nanoid.GeneratePublicID()`)
- **Internal ID**: int64 database primary keys for internal operations
- Repository query results include both IDs; domain models use public IDs externally

### Query Architecture

- Shared `query.QueryParams` structure supports filtering, pagination, sorting, keyword search
- Repository Query methods return `query.QueryResult[T]` with data + metadata
- Standard pattern: build query → count rows → add sorting → paginate → get filter values
- Keyword search across multiple fields using LOWER() and LIKE patterns
- Dynamic filter building with IN clauses for multi-value filters

### Database Conventions

- Table naming: `altalune_{domain_name}s` (plural)
- Required columns: `id`, `public_id`, `created_at`, `updated_at`
- Use pgx for database operations with proper error handling
- Map database strings ↔ domain enums ↔ protobuf enums

### Service Layer Pattern

- Embed `UnimplementedXXXServiceServer` for gRPC service implementation
- Inject dependencies: validator (protovalidate), logger, required repositories
- Validate protobuf requests → convert to domain inputs → call repository → map to proto response
- Use domain-specific errors with `altalune.NewXXXError()` helpers

### Integration Points

- Register repositories in `container.go:initRepositories()`
- Register services in `container.go:initServices()`
- Register gRPC services in `server/grpc_services.go`
- Add Connect routes in HTTP handler if needed

### Development Guidelines

- Always include both Query and Create operations as minimum viable domain
- Follow the employee/project domain patterns for consistency
- Use `buf.validate` for input validation in protobuf schemas
- Handle nullable database fields with `sql.NullString`/`sql.NullTime`
- Provide default enum values for unknown states
- Include artificial delays in services to match frontend expectations
